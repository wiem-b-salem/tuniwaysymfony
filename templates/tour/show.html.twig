{% extends 'base.html.twig' %}

{% block title %}Tour Details{% endblock %}

{% block body %}
    <h1>{{ tour.title }}</h1>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Tour Info</h5>
             <p class="d-flex align-items-center gap-2">
                 <strong>Guide:</strong> 
                 {% if tour.guide %}
                    <a href="{{ path('app_profile_show', {'id': tour.guide.id}) }}" class="text-decoration-none fw-bold">{{ tour.guide.username }}</a>
                    {% if app.user and app.user != tour.guide and 'ROLE_ADMIN' not in app.user.roles %}
                        <a href="{{ path('app_message_chat', {'id': tour.guide.id}) }}" class="btn btn-sm btn-outline-primary ms-2"><i class="bi bi-envelope-fill"></i> Contact</a>
                    {% endif %}
                 {% else %}
                    <span class="text-muted">No guide assigned</span>
                 {% endif %}
             </p>
             <p><strong>Price:</strong> ${{ tour.price }}</p>
             <p><strong>Duration:</strong> {{ tour.duration }} hours</p>
             <p><strong>Max Persons:</strong> {{ tour.maxPersons }}</p>
             <p><strong>Description:</strong> {{ tour.description }}</p>
        </div>
    </div>

    <h3>Included Places</h3>
    <ul>
    {% for place in tour.places %}
        <li>
            <a href="{{ path('app_place_show', {'id': place.id}) }}">{{ place.name }}</a>
        </li>
    {% else %}
        <li>No places selected.</li>
    {% endfor %}
    </ul>

    <a href="{{ path('app_tour_index') }}" class="btn btn-secondary">Back to List</a>

    <div class="card mb-4">
        <div class="card-header">Book this Tour</div>
        <div class="card-body">
            {% if app.user %}
                <form action="{{ path('app_reservation_book', {'id': tour.id}) }}" method="post">
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" id="date" name="date" class="form-control" required min="{{ 'now'|date('Y-m-d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="persons" class="form-label">Number of Persons</label>
                        <input type="number" id="persons" name="persons" class="form-control" min="1" max="{{ tour.maxPersons }}" value="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Request Reservation</button>
                </form>
            {% else %}
                <p>Please <a href="{{ path('app_login') }}">login</a> to book this tour.</p>
            {% endif %}
        </div>
    </div>

    {% if is_granted('ROLE_GUIDE') and app.user == tour.guide or is_granted('ROLE_ADMIN') %}
        <a href="{{ path('app_tour_edit', {'id': tour.id}) }}" class="btn btn-warning">Edit</a>
    {% endif %}

    <hr>
    {{ include('partials/_reviews.html.twig', {'reviews': tour.reviews, 'type': 'tour', 'subject_id': tour.id}) }}
{% endblock %}
